# ============================================================================
# GitHub Actions: Cron Job para Featured Ads Cleanup
# ============================================================================
# Ejecuta cada hora el endpoint que activa destacados pendientes y expira vencidos
# 
# Ventajas:
#   - âœ… Completamente GRATIS e ilimitado
#   - âœ… No requiere plan Pro de Render
#   - âœ… Logs auditables en GitHub
#   - âœ… FÃ¡cil de debuggear
#
# Setup:
#   1. Ir a GitHub Repo â†’ Settings â†’ Secrets and variables â†’ Actions
#   2. Crear secret: CRON_SECRET (copiar desde Render o generar nuevo)
#   3. Commit este archivo â†’ GitHub ejecutarÃ¡ automÃ¡ticamente
# ============================================================================

name: Featured Ads Cleanup Cron

on:
  # Ejecutar cada hora en punto
  schedule:
    - cron: '0 * * * *'  # Cada hora a las :00
  
  # Permitir ejecuciÃ³n manual desde GitHub UI
  workflow_dispatch:

jobs:
  cleanup-featured-ads:
    runs-on: ubuntu-latest
    
    steps:
      # ================================================================
      # Paso 1: Wake up del backend (Render free tier duerme tras 15min)
      # ================================================================
      - name: Wake up Render backend (cold start ~30-50s)
        run: |
          echo "â³ Despertando backend (Render free tier cold start)..."
          
          # Primer intento: despertar el servidor con health check
          # Render devuelve x-render-routing: no-server si estÃ¡ dormido
          for attempt in 1 2 3; do
            echo "  ğŸ”„ Intento wake-up $attempt/3..."
            
            wake_response=$(curl -s -o /dev/null -w "%{http_code}" \
              --connect-timeout 10 \
              --max-time 90 \
              https://rural24.onrender.com/api/health)
            
            echo "  ğŸ“¡ Health check response: HTTP $wake_response"
            
            if [ "$wake_response" -eq 200 ]; then
              echo "  âœ… Backend despierto y healthy!"
              break
            elif [ "$wake_response" -eq 404 ]; then
              echo "  ğŸ’¤ Servidor aÃºn dormido (404 = no-server), esperando..."
              sleep 30
            else
              echo "  âš ï¸ Respuesta inesperada ($wake_response), esperando..."
              sleep 15
            fi
          done
          
          # Verificar que despertÃ³
          final_check=$(curl -s -o /dev/null -w "%{http_code}" \
            --connect-timeout 10 \
            --max-time 60 \
            https://rural24.onrender.com/api/health)
          
          if [ "$final_check" -ne 200 ]; then
            echo "âš ï¸ Backend no respondiÃ³ healthy (HTTP $final_check). Intentando cron de todos modos..."
          fi

      # ================================================================
      # Paso 2: Ejecutar el cron de featured ads
      # ================================================================
      - name: Activate pending and expire old featured ads
        run: |
          echo "ğŸš€ Ejecutando featured ads cleanup..."
          
          # Validar que CRON_SECRET estÃ¡ configurado
          if [ -z "$CRON_SECRET" ]; then
            echo "âŒ ERROR: CRON_SECRET no estÃ¡ configurado en GitHub Secrets"
            echo "ğŸ‘‰ Ir a: GitHub Repo â†’ Settings â†’ Secrets â†’ Actions â†’ New secret"
            echo "ğŸ‘‰ Nombre: CRON_SECRET"
            echo "ğŸ‘‰ Valor: copiarlo desde Render Dashboard â†’ rural24-backend â†’ Environment"
            exit 1
          fi
          
          response=$(curl -X POST https://rural24.onrender.com/api/featured-ads/cron \
            -H "X-Cron-Secret: $CRON_SECRET" \
            -H "Content-Type: application/json" \
            --connect-timeout 30 \
            --max-time 120 \
            --retry 2 \
            --retry-delay 15 \
            --retry-all-errors \
            -w "\nHTTP_STATUS:%{http_code}" \
            -s)
          
          http_status=$(echo "$response" | grep "HTTP_STATUS" | cut -d':' -f2)
          body=$(echo "$response" | sed '/HTTP_STATUS/d')
          
          echo "ğŸ“Š Response Status: $http_status"
          echo "ğŸ“¦ Response Body: $body"
          
          if [ "$http_status" -eq 200 ] || [ "$http_status" -eq 201 ]; then
            echo "âœ… Cron ejecutado exitosamente"
            exit 0
          elif [ "$http_status" -eq 401 ]; then
            echo "âŒ Error 401: CRON_SECRET invÃ¡lido o no coincide con Render"
            echo "ğŸ‘‰ Verificar que el secret en GitHub Actions coincide con el de Render"
            exit 1
          elif [ "$http_status" -eq 404 ]; then
            echo "âŒ Error 404: Backend no estÃ¡ corriendo (Render free tier suspendido?)"
            echo "ğŸ‘‰ Verificar en https://dashboard.render.com que rural24-backend estÃ© activo"
            echo "ğŸ‘‰ Header x-render-routing: no-server = el servicio estÃ¡ dormido/suspendido"
            exit 1
          else
            echo "âŒ Error en cron (HTTP $http_status)"
            exit 1
          fi
        env:
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
      
      - name: Log execution time
        if: always()
        run: |
          echo "â° Ejecutado: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

# ============================================================================
# ALTERNATIVA: Ejecutar cada 2 horas (menos frecuente)
# ============================================================================
# Si querÃ©s reducir frecuencia (aunque GitHub Actions es gratis):
# schedule:
#   - cron: '0 */2 * * *'  # Cada 2 horas
#   - cron: '0 0,6,12,18 * * *'  # 4 veces al dÃ­a (00:00, 06:00, 12:00, 18:00)
#   - cron: '0 0 * * *'  # Una vez al dÃ­a a medianoche
